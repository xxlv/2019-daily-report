## 2019年1月11日 HZ 多云+雨  风暴-0111

> 除了BUG 一无所有

故事要从一个用户余额开始，查询到用户的余额为负数。业务场景是拨打电话。模式是AxB。

> Axb 是通过一个虚拟号绑定两个号码，然后A号码通过拨打虚拟号被映射到B号码的过程，可以有效的保护A号码和B号码的隐私。

#### 场景
在拨打电话生成X号码的时候，系统会判断余额，然后接通两个用户，在通话完毕后，挂断回调里面生成订单。


#### 猜想 绕过了余额验证

第一个可能的原因就是有地方绕过了系统的验证，但是查询到线上的用户数量比较多，每个用户都是真实存在且比较老的。所以暂不考虑抓包利用工具绕过验证。首先考虑本身业务逻辑问题。

检查了自身的业务逻辑，发现了在一个地方接受了来自客户端的字段用来判断是否跳过检查余额和其他常规检查。目测大概率是这个原因，因此拒绝了客户端的参数，由服务器来自己检查。

不要信任任何人

##### 猜想2 业务漏洞
在AxB模式生成订单的时候，系统依赖于回调的结果。  

Case 1: 在一个场景里，用户有50RMB，购买订单话费了50，但是因为订单在回调的时候才计算，如果在订单处理的中途，这50RMB被用户以某种手段转移，则用户在回调来的时候，订单已经是0，在扣款会变成负数。（系统中，负数的余额是允许的）

Case 2: 在一个订单结束后，用户立即拨打下一个订单，此时检查的时候，用户的余额还是50，所以第二个订单检查合法，进入订单核心逻辑。接着第一个订单的回调到来，扣款。第二个订单的回调来，会导致金额为负。


### 生活

女朋友在开年会~看来我要早早回家。袋鼠这个SB竟然大雨天租了辆车。

23:53 

晚上跟女朋友聊天聊的很开心，这货的英文竟然是6级的，跟她英文对话有点吃力...

希望今天再打一盘星际就早点睡觉~ 晚安~




