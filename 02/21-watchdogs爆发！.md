## 2019年2月21日 HZ 天气阴雨  风暴-0221


>最近一种watchdogs 的病毒通过redis入侵感染ssh横向传播。觉得很有意思，我想从病毒的创造者的角度来分析这个病毒是如何产生的。

首先，我们要编写一款病毒程序，能够感染宿主机（Linux），它需要做到
    **获得绝大多数的CPU**
    **隐藏自己**
    **守护自己**
    **执行挖坑脚本**


首先从最简单的入手，我们要挖坑，需要选择一种虚拟货币，XMR是一个很好的选择（pow）。基于pow的还有比特币，但是cpu基本已经没办法挖到了，难度太高。
我们假设获得到了挖xmr的程序（开源程序）。xmr-miner。


### 隐藏自己

其次，我们需要编写隐藏脚本，保证自己不被发现，隐藏真实的cpu不被用户感知。
 
 - 隐藏真实CPU
用户是如何感知到cpu异常的呢？一般用户会通过top等linux系统命令进行查看。如果有一种方法能够展示虚假的top信息，是不是就可以隐藏cpu的占有率呢？
    
- 隐藏进程
我们一般使用ps aux |grep xxx 类似这样的命令来查看后台的进程，所以，为了达到隐藏自己的目的，我们还需要让ps等系统指令给出虚假的信息

要达到这两个目的，我们要怎么做呢？ 这是一个难题。


### 守护自己
我们需要尽可能多的唤醒自己的程序，常见的，比如增加到定时任务中，并且保证定时任务很难被重写。  还可以编写deamon。 

deamon的编写思路非常简单，启动deamon后检测目标程序如果没有启动，则启动。  这两个程序可以互为deamon。


### 抢夺CPU

为了抢夺CPU,我们需要杀死一些额外的占据CPU的进程，甚至杀死一些常见的竞争对手病毒。

### 合并

上面是我们的准备工作，当这一切都就绪的时候，我们就需要将几部分链接在一起，该如何将这几个部分合并在一起呢？ 

这需要一些额外的知识，暂且假设我们将这三个程序打包到一起，并给是可以执行了。


### 扩散

从最简单的扩赛开始，我们需要编写一点扩散脚本，通过ssh来横向感染。shell可以扫描ssh know keys 遍历并且尝试连接执行我们的脚本。


### 扩散方式

最后需要考虑，我们最好不要把一个病毒.exe放在用户的电脑上，相反的，我们可以将病毒.exe隐藏在某些文件里面，比如一张图。这还是一个比较棘手的问题，但是我们假设现在也完成了它。


### 切入

我们需要在全网感染机器，一个可能的方式是，通过已知的安全漏洞和隐患来感染全球机器，并且配合ssh横向感染，使得感染的机器的数量达到最高。假设我们扫描redis，通过bind 0.0.0.0 默认无密码这个漏洞来感染写入。


### 可控

我们需要在远端控制，意味着脚本是动态拉去的，为了达到这一点，可以利用一个开源的匿名的网站来上传自己的病毒代码。宿主机器上通过curl来下载恶意代码。


我们已经有了一个病毒完整的传播流程，虽然某些技术问题还需要很多时间来解决。














